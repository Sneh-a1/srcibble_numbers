{% extends 'digit/home.html' %}

{% block hero %}
<div class="quicksand-appfont min-h-screen bg-green-100 flex flex-col items-center justify-center px-6 py-8 relative">
    {% csrf_token %}
    <a href="{% url 'home' %}" class="absolute top-6 left-6 px-4 py-2 bg-white text-green-600 rounded-lg shadow-md hover:bg-green-50 transition-colors flex items-center gap-2 font-semibold">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
        </svg>
        Home
    </a>
    <div class="bg-white rounded-lg shadow-lg p-8 max-w-2xl w-full">
        <div class="text-2xl text-green-700 font-semibold mb-6 text-center">
            <p>Draw Number: <span class="text-pink-300 font-bold capitalize">{{ target_text }}</span></p>
        </div>
        
        <div class="flex flex-col items-center gap-4">
            <canvas id="drawingCanvas" 
                    class="border-4 border-green-500 rounded-lg bg-white cursor-crosshair shadow-md" 
                    width="400" 
                    height="400" >
            </canvas>
            
            <div class="flex gap-4">
                <button id="clearBtn" class="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                    Clear
                </button>
                <button id="submitBtn" class="px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                    Submit
                </button>
            </div>
        </div>
    </div>
</div>

<script>

    const canvas = document.getElementById('drawingCanvas');
    const ctx = canvas.getContext('2d');
    let isDrawing = false;

    function isValidCsrfToken(token) {
        return typeof token === 'string' && (token.length === 32 || token.length === 64);
    }

    function getCsrfToken() {
        const csrfTokenInput = document.querySelector('[name=csrfmiddlewaretoken]');
        const tokenFromInput = csrfTokenInput ? csrfTokenInput.value : '';
        if (isValidCsrfToken(tokenFromInput)) {
            return tokenFromInput;
        }

        const tokenFromCookie = getCookie('csrftoken');
        if (isValidCsrfToken(tokenFromCookie)) {
            return tokenFromCookie;
        }

        return '';
    }

    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) {
            return parts.pop().split(';').shift();
        }
        return '';
    }

    function hasDrawing() {
        const data = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
        for (let i = 0; i < data.length; i += 4) {
            if (data[i] < 250 || data[i + 1] < 250 || data[i + 2] < 250) {
                return true;
            }
        }
        return false;
    }

    function sendImage(){
        if (!hasDrawing()) {
            alert("Canvas is empty. Please draw a digit first.");
            return;
        }

        var image = canvas.toDataURL("image/png");
        const csrfToken = getCsrfToken();

        fetch("{% url 'predict' %}",{
            method:"POST",
            headers:{
                "Content-Type":"application/x-www-form-urlencoded",
                "X-CSRFToken" : csrfToken
            },
            credentials: "same-origin",
            body : "image=" + encodeURIComponent(image)
        })
        .then(response => response.json())
        .then(data=>{
            if(data.success && data.redirect){
                // Redirect to result page
                window.location.href = data.redirect;
            } else if(data.error) {
                alert("Error: " + data.error);
            }
        })
        .catch(error => {
            alert("Failed to submit drawing. Please try again.");
            console.error("Error:", error);
        });
    }
    
    // Fill canvas with white background
    function fillWhiteBackground() {
        ctx.fillStyle = '#FFFFFF';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
    }
    
    // Set canvas size based on screen width
    function setCanvasSize() {
        if (window.innerWidth < 768) {
            // Mobile/medium screens
            canvas.width = 300;
            canvas.height = 300;
            ctx.lineWidth = 26;  // Proportional: 35 * (300/400)
        } else {
            // Desktop screens
            canvas.width = 400;
            canvas.height = 400;
            ctx.lineWidth = 35;  // Thicker lines for better recognition
        }
        // Fill with white background after resize
        fillWhiteBackground();
        // Reset canvas context after resize
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';  // Smooth corners
        ctx.strokeStyle = '#000000';
    }
    
    // Set initial size
    setCanvasSize();
    
    // Update size on window resize
    window.addEventListener('resize', setCanvasSize);
    
    canvas.addEventListener('mousedown', (e) => {
        isDrawing = true;
        ctx.beginPath();
        ctx.moveTo(e.offsetX, e.offsetY);
    });
    
    canvas.addEventListener('mousemove', (e) => {
        if (isDrawing) {
            ctx.lineTo(e.offsetX, e.offsetY);
            ctx.stroke();
        }
    });
    
    canvas.addEventListener('mouseup', () => {
        isDrawing = false;
    });
    
    canvas.addEventListener('mouseleave', () => {
        isDrawing = false;
    });

    // Touch support for mobile devices
    canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        const touch = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        isDrawing = true;
        ctx.beginPath();
        ctx.moveTo(touch.clientX - rect.left, touch.clientY - rect.top);
    });

    canvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        if (isDrawing) {
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            ctx.lineTo(touch.clientX - rect.left, touch.clientY - rect.top);
            ctx.stroke();
        }
    });

    canvas.addEventListener('touchend', (e) => {
        e.preventDefault();
        isDrawing = false;
    });
    
    document.getElementById('clearBtn').addEventListener('click', () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        fillWhiteBackground();
    });
    
    document.getElementById('submitBtn').addEventListener('click', () => {
        sendImage();
    });
</script>

{% endblock hero %}
